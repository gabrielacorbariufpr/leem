
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel de Finalização - LEEM</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="card">
  <h1>Painel de Finalização</h1>

  <div class="info">
    <p><strong>Nome:</strong> <span id="nomeUsuario"></span></p>
    <p><strong>Professor(a):</strong> <span id="nomeProfessor"></span></p>
    <p><strong>Disciplina:</strong> <span id="nomeDisciplina"></span></p>
    <p><strong>XP Final:</strong> <span id="xpFinal">0</span></p>
    <p><strong>Tempo Total:</strong> <span id="tempoFinal">00:00</span></p>
    <p><strong>Ranking XP:</strong> <span id="rankingXP">-</span></p>
    <p><strong>Ranking Tempo:</strong> <span id="rankingTempo">-</span></p>
    <p><strong>Medalha:</strong> <span id="medalha">-</span></p>
  </div>

  <h3>Histórico de Respostas</h3>
  <div id="historicoRespostas"></div>

  <div class="acoes">
    <button onclick="window.location.href='pos-avaliacao.html'">🔄 Refazer</button>
    <button onclick="window.location.href='index.html'">🏠 Voltar ao Início</button>
  </div>
</div>

<script>
const supabaseUrl = 'https://wuwdkyfcugmmofziuqmo.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind1d2RreWZjdWdtbW9meml1cW1vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgwMDgwMDksImV4cCI6MjA2MzU4NDAwOX0.ZEBr1OKGW_rPD9tUeAucx3Ugj4R5kfxcfzZg9iEmdr4';
const supabase = supabase.createClient(supabaseUrl, supabaseKey);

const nome = localStorage.getItem('nome') || prompt('Digite seu nome para visualizar seu painel:');
const professor = localStorage.getItem('professor') || '';
const disciplina = localStorage.getItem('disciplina') || '';

document.getElementById('nomeUsuario').textContent = nome;
document.getElementById('nomeProfessor').textContent = professor;
document.getElementById('nomeDisciplina').textContent = disciplina;

async function carregarDados() {
  const { data, error } = await supabase
    .from('respostas')
    .select('*')
    .eq('usuario', nome);

  if (error) {
    console.error('Erro ao carregar dados:', error);
    return;
  }

  const xpTotal = data.reduce((sum, r) => sum + (r.xp || 0), 0);
  const tempos = data.map(r => r.tempo || '00:00');
  const tempoFinal = tempos.length > 0 ? tempos[tempos.length - 1] : '00:00';

  document.getElementById('xpFinal').textContent = xpTotal;
  document.getElementById('tempoFinal').textContent = tempoFinal;

  // Histórico de respostas
  const historicoDiv = document.getElementById('historicoRespostas');
  data.forEach(r => {
    const p = document.createElement('p');
    p.textContent = `Etapa: ${r.etapa} → ${r.resposta}`;
    historicoDiv.appendChild(p);
  });

  // Ranking XP
  const { data: rankingXP } = await supabase
    .rpc('ranking_xp');

  const posXP = rankingXP.findIndex(u => u.usuario === nome) + 1;
  document.getElementById('rankingXP').textContent = posXP > 0 ? `${posXP}º lugar` : 'N/A';

  // Ranking Tempo
  const { data: rankingTempo } = await supabase
    .rpc('ranking_tempo');

  const posTempo = rankingTempo.findIndex(u => u.usuario === nome) + 1;
  document.getElementById('rankingTempo').textContent = posTempo > 0 ? `${posTempo}º lugar` : 'N/A';

  // Medalhas
  const medalha = posXP === 1 ? '🏅 Ouro'
                : posXP === 2 ? '🥈 Prata'
                : posXP === 3 ? '🥉 Bronze'
                : '🎖️ Participação';
  document.getElementById('medalha').textContent = medalha;
}

carregarDados();
</script>

</body>
</html>
