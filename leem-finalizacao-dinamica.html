<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel de FinalizaÃ§Ã£o - LEEM</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="card">
  <h1>Painel de FinalizaÃ§Ã£o</h1>

  <div class="info">
    <p><strong>Nome:</strong> <span id="nomeUsuario"></span></p>
    <p><strong>Professor(a):</strong> <span id="nomeProfessor"></span></p>
    <p><strong>Disciplina:</strong> <span id="nomeDisciplina"></span></p>
    <p><strong>XP Final:</strong> <span id="xpFinal">0</span></p>
    <p><strong>Tempo Total:</strong> <span id="tempoFinal">00:00</span></p>
    <p><strong>Ranking XP:</strong> <span id="rankingXP">-</span></p>
    <p><strong>Ranking Tempo:</strong> <span id="rankingTempo">-</span></p>
    <p><strong>Medalha:</strong> <span id="medalha">-</span></p>
  </div>

  <h2>ğŸ† Ranking XP - Top 3</h2>
  <div id="rankingXPTop"></div>

  <h2>â±ï¸ Ranking Tempo - Top 3</h2>
  <div id="rankingTempoTop"></div>

  <h3>ğŸ“œ HistÃ³rico de Respostas</h3>
  <div id="historicoRespostas"></div>

  <div class="acoes">
    <button onclick="window.location.href='pos-avaliacao.html'">ğŸ”„ Refazer</button>
    <button onclick="window.location.href='index.html'">ğŸ  Voltar ao InÃ­cio</button>
    <button onclick="compartilharComProfessor()">ğŸ“¤ Compartilhar</button>
    <button onclick="gerarPDF()">ğŸ–¨ï¸ Gerar PDF</button>
  </div>
</div>

<script>
const supabaseUrl = 'https://wuwdkyfcugmmofziuqmo.supabase.co';
const supabaseKey = 'YOUR_KEY';
const supabase = supabase.createClient(supabaseUrl, supabaseKey);

const nome = localStorage.getItem('nome') || 'UsuÃ¡rio';
const professor = localStorage.getItem('professor') || 'Professor';
const disciplina = localStorage.getItem('disciplina') || 'Disciplina';

document.getElementById('nomeUsuario').textContent = nome;
document.getElementById('nomeProfessor').textContent = professor;
document.getElementById('nomeDisciplina').textContent = disciplina;

async function carregarDados() {
  const { data, error } = await supabase
    .from('respostas')
    .select('*')
    .eq('usuario', nome);

  if (error) {
    console.error('Erro ao carregar dados:', error);
    return;
  }

  const xpTotal = data.reduce((sum, r) => sum + (r.xp || 0), 0);
  const tempoFinal = data.length > 0 ? data[data.length - 1].tempo : '00:00';

  document.getElementById('xpFinal').textContent = xpTotal;
  document.getElementById('tempoFinal').textContent = tempoFinal;

  const historicoDiv = document.getElementById('historicoRespostas');
  data.forEach(r => {
    const p = document.createElement('p');
    p.textContent = `Etapa ${r.etapa}: ${r.resposta}`;
    historicoDiv.appendChild(p);
  });

  // Rankings
  const { data: rankingXP } = await supabase.rpc('ranking_xp');
  const { data: rankingTempo } = await supabase.rpc('ranking_tempo');

  const posXP = rankingXP.findIndex(u => u.usuario === nome) + 1;
  const posTempo = rankingTempo.findIndex(u => u.usuario === nome) + 1;

  document.getElementById('rankingXP').textContent = posXP > 0 ? `${posXP}Âº lugar` : 'N/A';
  document.getElementById('rankingTempo').textContent = posTempo > 0 ? `${posTempo}Âº lugar` : 'N/A';

  // Top 3 XP
  const xpTop = rankingXP.slice(0, 3);
  document.getElementById('rankingXPTop').innerHTML = xpTop.map((u, i) =>
    `<p>${i + 1}Âº ${u.usuario} - â­ ${u.total_xp} XP</p>`
  ).join('');

  // Top 3 Tempo
  const tempoTop = rankingTempo.slice(0, 3);
  document.getElementById('rankingTempoTop').innerHTML = tempoTop.map((u, i) =>
    `<p>${i + 1}Âº ${u.usuario} - â±ï¸ ${u.tempo_total}</p>`
  ).join('');

  // Medalha
  const medalha = posXP === 1 ? 'ğŸ… Ouro'
                : posXP === 2 ? 'ğŸ¥ˆ Prata'
                : posXP === 3 ? 'ğŸ¥‰ Bronze'
                : 'ğŸ–ï¸ ParticipaÃ§Ã£o';
  document.getElementById('medalha').textContent = medalha;
}

function compartilharComProfessor() {
  const texto = `OlÃ¡ Professor(a) ${professor}, eu conclui minha missÃ£o na disciplina ${disciplina}!\nâ­ XP: ${document.getElementById('xpFinal').textContent}\nâ±ï¸ Tempo: ${document.getElementById('tempoFinal').textContent}\nRanking XP: ${document.getElementById('rankingXP').textContent}\nRanking Tempo: ${document.getElementById('rankingTempo').textContent}.`;
  const url = `https://wa.me/?text=${encodeURIComponent(texto)}`;
  window.open(url, '_blank');
}

function gerarPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  doc.text('Painel de FinalizaÃ§Ã£o - LEEM', 10, 10);
  doc.text(`Nome: ${nome}`, 10, 20);
  doc.text(`Professor(a): ${professor}`, 10, 30);
  doc.text(`Disciplina: ${disciplina}`, 10, 40);
  doc.text(`XP Final: ${document.getElementById('xpFinal').textContent}`, 10, 50);
  doc.text(`Tempo: ${document.getElementById('tempoFinal').textContent}`, 10, 60);
  doc.text(`Ranking XP: ${document.getElementById('rankingXP').textContent}`, 10, 70);
  doc.text(`Ranking Tempo: ${document.getElementById('rankingTempo').textContent}`, 10, 80);
  doc.text(`Medalha: ${document.getElementById('medalha').textContent}`, 10, 90);

  doc.save('finalizacao-leem.pdf');
}

carregarDados();
</script>

</body>
</html>
